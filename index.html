<!--
  Updated LINK ()()()
  index.html
  PURPOSE: A minimal, browser-only password reset page for Supabase Auth.
  HOSTING: You can host this file on any static host (GitHub Pages, Netlify, Vercel, S3+CloudFront, etc.).
-->

<!DOCTYPE html> <!-- Declares HTML5 document type for the browser -->
<html lang="en"> <!-- Sets the document language to English for accessibility/search -->
<head> <!-- Head contains metadata and scripts/styles that load before the page renders -->
  <meta charset="UTF-8" /> <!-- Ensures proper character encoding for all text -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Makes layout responsive on mobile -->
  <title>Reset your password</title> <!-- Browser tab title -->

  <!-- 
    Load Supabase JS from a CDN (official ESM build).
    This gives us the `createClient` function in a module context below.
  -->
 <script type="module">
  // --- 0) Import Supabase client (ESM build) ---
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // --- 1) YOUR PROJECT CREDENTIALS (leave as you set them earlier) ---
  const SUPABASE_URL = "https://hazfkudticoqhtoobvpu.supabase.co";   // ← your project URL
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhemZrdWR0aWNvcWh0b29idnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTc1ODcsImV4cCI6MjA3NDU3MzU4N30.QsOwyZXGOWrAv5Aj_gL0II3B970ocebhCCKeK4BgMUw";                 // ← your anon public key
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);     // builds a browser client

  // --- 2) Grabbing DOM elements we’ll update ---
  const statusEl = document.getElementById("status");     // shows status/errors
  const formEl = document.getElementById("reset-form");   // new-password form
  const pass1El = document.getElementById("password");    // new password
  const pass2El = document.getElementById("password2");   // confirm password
  const submitEl = document.getElementById("submit-btn"); // submit button
  // Grab the checklist items we added earlier so we can toggle them on/off.
  const ruleItems = document.querySelectorAll("#pw-rules .req");           // selects every <li class="req"> inside the #pw-rules list
  // Build a map from data-rule attribute -> element for quick access.
  const rulesMap = Array.from(ruleItems).reduce((acc, li) => {             // convert NodeList to array and iterate each <li>
    acc[li.dataset.rule] = li;                                             // use the data-rule value (e.g., "len","lower") as the key, and store the element
    return acc;                                                            // return the accumulator on each iteration
  }, {});                                                                  // start with an empty object


  // --- 3) Parse both possible URL formats from Supabase ---
  const url = new URL(window.location.href);              // full current URL
  const authCode = url.searchParams.get("code");          // ?code=XYZ style (PKCE)
  const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, "")); // #access_token=… style
  const hashAccessToken = hashParams.get("access_token"); // token from hash
  const hashRefreshToken = hashParams.get("refresh_token");
  const hashType = hashParams.get("type");                // should be "recovery" for PW reset

  // --- 4) Try to establish a session, supporting both formats ---
  async function establishSession() {
    // 4a) New-style links: https://site/reset?code=XYZ
    if (authCode) {
      const { error } = await supabase.auth.exchangeCodeForSession({ authCode });
      if (error) {
        statusEl.textContent = `Could not start reset session: ${error.message}`;
        formEl.style.display = "none";
        return;
      }
      statusEl.textContent = "Session verified. Enter your new password below.";
      formEl.style.display = "block";
      return;
    }

    // 4b) Legacy/redirect links: https://site/reset/#access_token=…&refresh_token=…&type=recovery
    if (hashAccessToken && hashRefreshToken && hashType === "recovery") {
      const { data, error } = await supabase.auth.setSession({
        access_token: hashAccessToken,
        refresh_token: hashRefreshToken,
      });
      if (error) {
        statusEl.textContent = `Could not restore session: ${error.message}`;
        formEl.style.display = "none";
        return;
      }
      statusEl.textContent = "Session verified. Enter your new password below.";
      formEl.style.display = "block";
      return;
    }

    // 4c) Neither format was present → user didn’t arrive from a reset email
    statusEl.textContent = "Missing 'code' in URL. Open this page from your email reset link.";
    formEl.style.display = "none";
  }

  // --- 5) Submit handler: update password once session exists ---
  // --- Submit handler: final validation + submit hardening ---
  let submitting = false;                                                    // global flag to prevent double-submits

  formEl.addEventListener("submit", async (e) => {                           // listen for the form's submit event
    e.preventDefault();                                                      // stop the browser from reloading the page

    if (submitting) return;                                                  // if already submitting, ignore additional clicks
    submitting = true;                                                       // set the in-flight lock to true immediately

    try {                                                                    // begin guarded try/catch block to surface any runtime errors
      const pw = pass1El.value || "";                                        // read the first password field (fallback to empty string)
      const pw2 = pass2El.value || "";                                       // read the confirmation field

      // 1) Re-run full validation at submit time to catch paste/autofill edge cases.
      const states = evaluatePasswordRules(pw);                              // compute all rule booleans for the entered password
      const allRulesPass = Object.values(states).every(Boolean);             // true only if every rule is satisfied
      const matches = pw.length > 0 && pw === pw2;                           // ensure both fields are non-empty and identical

      renderRuleStates(states);                                              // reflect the latest rule states in the checklist UI

      if (!allRulesPass) {                                                   // if any rule is unmet, explain and stop
        statusEl.textContent = "Please meet all password requirements before submitting."; // user-facing guidance
        submitEl.disabled = true;                                            // keep button disabled until they fix inputs
        return;                                                              // exit early due to rule failure
      }

      if (!matches) {                                                        // if the two fields do not match, explain and stop
        statusEl.textContent = "Passwords do not match.";                    // specific mismatch message
        submitEl.disabled = true;                                            // require correction before re-enabling submit
        return;                                                              // exit early due to mismatch
      }

      // 2) Disable the button while the network request is in-flight.
      submitEl.disabled = true;                                              // prevents accidental double-clicks
      statusEl.textContent = "Updating password…";                           // optimistic progress feedback

      // 3) Call Supabase to update the password on the authenticated recovery session.
      const { error } = await supabase.auth.updateUser({ password: pw });    // perform the password update via Supabase

      if (error) {                                                           // if Supabase returned an error, surface it to the user
        statusEl.textContent = `Error: ${error.message}`;                    // show the exact error message
        submitEl.disabled = false;                                           // allow the user to try again after fixing input
        return;                                                              // stop here on failure
      }

      // 4) Success → brief confirmation, then redirect to your success page.
      statusEl.textContent = "Password updated successfully. Redirecting…";  // success message to reassure the user
      setTimeout(() => {                                                     // short delay so the user can read the message
        window.location.assign("success.html");                              // navigate to the success page you created
      }, 800);                                                               // ~0.8s feels responsive yet readable

    } catch (err) {                                                          // catch any unexpected runtime errors
      statusEl.textContent = `Unexpected error: ${String(err)}`;             // show a generic but informative message
      submitEl.disabled = false;                                             // re-enable the button so the user can retry
    } finally {                                                              // always run, success or failure
      submitting = false;                                                    // release the in-flight lock so future submits are allowed
    }
  });


  // --- 6) Kick off the session establishment on page load ---
  establishSession();                               // handles both URL styles

  // --- 7) Password visibility toggle functionality ---
  document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);

      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'Hide';
      } else {
        input.type = 'password';
        this.textContent = 'Show';
      }
    });
  });
  // --- 8) Real-time password strength validation ---
  // Define the actual checks your Supabase policy requires (min 8 + lower + upper + digit + symbol).
  function evaluatePasswordRules(pw) {                                     // function that returns an object of booleans for each rule
    return {
      len: pw.length >= 8,                                                 // true when at least 8 characters long
      lower: /[a-z]/.test(pw),                                             // true when it contains a lowercase letter a–z
      upper: /[A-Z]/.test(pw),                                             // true when it contains an uppercase letter A–Z
      digit: /\d/.test(pw),                                                // true when it contains a digit 0–9
      symbol: /[^A-Za-z0-9]/.test(pw),                                     // true when it contains any non-alphanumeric symbol
    };                                                                     // the object mirrors the data-rule attributes on your <li> elements
  }

  // Update the UI (green/bold) for each checklist line item.
  function renderRuleStates(states) {                                      // accepts the object returned by evaluatePasswordRules
    Object.entries(states).forEach(([key, ok]) => {                        // loop each rule: key is "len"/"lower"/..., ok is boolean
      const li = rulesMap[key];                                            // find the corresponding <li> by the same key
      if (!li) return;                                                     // safety guard: skip if no matching element (shouldn't happen)
      li.classList.toggle("ok", ok);                                       // add class "ok" when true (turns green/bold), remove when false
    });                                                                    // finished updating all lines
  }

  // Determine whether the form can be submitted right now.
  function canSubmitNow() {                                                // returns true only when all rules pass AND both fields match
    const pw = pass1El.value || "";                                        // read the first password field (empty string if null)
    const pw2 = pass2El.value || "";                                       // read the confirm password field
    const states = evaluatePasswordRules(pw);                              // compute current rule booleans for pw
    const allRulesPass = Object.values(states).every(Boolean);             // true only if every rule boolean is true
    const matches = pw.length > 0 && pw === pw2;                           // both fields must be non-empty and identical
    renderRuleStates(states);                                              // reflect rule state in the checklist UI
    return allRulesPass && matches;                                        // only allow submit when rules pass and passwords match
  }

  // Recompute on every keystroke in either password field.
  function onPasswordInput() {                                             // event handler to run on each input change
    const okToSubmit = canSubmitNow();                                     // ask whether we meet all conditions
    submitEl.disabled = !okToSubmit;                                       // enable the button if true; disable if false
    if (!okToSubmit) {                                                     // when not ready, provide a gentle hint
      statusEl.textContent = "Enter a strong password and make sure both fields match."; // guidance text
    } else {                                                               // when ready, clear status so the button feels actionable
      statusEl.textContent = "Looks good — you can update your password."; // positive confirmation
    }
  }

  // Attach the real-time listeners (fires on each keystroke).
  pass1El.addEventListener("input", onPasswordInput);                      // validate as the user types in the first field
  pass2El.addEventListener("input", onPasswordInput);                      // validate as the user types in the confirmation field

  // Run once on load in case the browser autofills saved values.
  onPasswordInput();                                                       // initializes the checklist and button state immediately

</script>


  <!-- Very light, inline styles for a clean, centered form without external CSS -->
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 1.5rem;
      display: grid;
      place-items: center;
      min-height: 100dvh;
      background-color: #f5f5f5;
    }
    .card {
      max-width: 420px;
      width: 100%;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      background: white;
    }
    h1 {
      margin: 0 0 1rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a1a1a;
    }
    p {
      margin: 0 0 1.5rem;
      color: #666;
      line-height: 1.5;
    }
    label {
      display: block;
      margin: 1.25rem 0 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: #333;
    }
    label:first-of-type {
      margin-top: 0;
    }
    .input-wrapper {
      position: relative;
      width: 100%;
    }
    input {
      width: 100%;
      padding: 0.75rem 3rem 0.75rem 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    button {
      margin-top: 1.5rem;
      width: 100%;
      padding: 0.875rem;
      border: 0;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      background-color: #3b82f6;
      color: white;
      transition: background-color 0.2s;
    }
    button:hover:not(:disabled) {
      background-color: #2563eb;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .toggle-password {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      transition: color 0.2s;
      width: auto;
      margin: 0;
    }
    .toggle-password:hover {
      color: #3b82f6;
    }
    /* Visual state for each requirement line */
    .req { color:#6b7280; }               /* default = gray text until the rule passes */
    .req.ok { color:#059669; font-weight:600; } /* when a rule is satisfied, turn green + bold */
  </style>
</head>
<body> <!-- Body contains visible content and the form markup -->
  <div class="card"> <!-- A simple container with a subtle card look -->
    <h1>Reset your password</h1> <!-- Page heading -->
    <p id="status">Verifying link…</p> <!-- Area to show live status and any errors -->

    <!-- Hidden by default; becomes visible after the auth code is successfully exchanged -->
    <form id="reset-form" style="display:none;">
      <label for="password">New password</label> <!-- Label for the first password input -->
      <div class="input-wrapper">
        <input id="password" type="password" autocomplete="new-password" required /> <!-- First password field -->
        <button type="button" class="toggle-password" data-target="password">Show</button>
      </div>
      <!-- Password requirements checklist shown to the user -->
      <ul id="pw-rules" style="margin:0.5rem 0 0; padding-left:1.25rem;"> <!-- unordered list to display each rule -->
          <li class="req" data-rule="len">At least 8 characters</li>          <!-- rule: minimum length -->
          <li class="req" data-rule="lower">Contains a lowercase letter (a–z)</li> <!-- rule: lowercase -->
          <li class="req" data-rule="upper">Contains an uppercase letter (A–Z)</li> <!-- rule: uppercase -->
          <li class="req" data-rule="digit">Contains a digit (0–9)</li>            <!-- rule: number -->
          <li class="req" data-rule="symbol">Contains a symbol (!@#$…)</li>        <!-- rule: symbol -->
      </ul>

      <label for="password2">Confirm new password</label> <!-- Label for the confirm password input -->
      <div class="input-wrapper">
        <input id="password2" type="password" autocomplete="new-password" required /> <!-- Confirmation field -->
        <button type="button" class="toggle-password" data-target="password2">Show</button>
      </div>

      <button id="submit-btn" type="submit">Update password</button> <!-- Submit button to trigger updateUser -->
    </form>
  </div>
</body>
</html>

