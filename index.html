<!--
  index.html
  PURPOSE: A minimal, browser-only password reset page for Supabase Auth.
  HOSTING: You can host this file on any static host (GitHub Pages, Netlify, Vercel, S3+CloudFront, etc.).
-->

<!DOCTYPE html> <!-- Declares HTML5 document type for the browser -->
<html lang="en"> <!-- Sets the document language to English for accessibility/search -->
<head> <!-- Head contains metadata and scripts/styles that load before the page renders -->
  <meta charset="UTF-8" /> <!-- Ensures proper character encoding for all text -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Makes layout responsive on mobile -->
  <title>Reset your password</title> <!-- Browser tab title -->

  <!-- 
    Load Supabase JS from a CDN (official ESM build).
    This gives us the `createClient` function in a module context below.
  -->
  <script type="module">
    // -----------------------------
    // 1) CONFIGURE SUPABASE CLIENT
    // -----------------------------

    // Import the ESM build of Supabase JS directly from the CDN at runtime.
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  
    const SUPABASE_URL = "https://hazfkudticoqhtoobvpu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhemZrdWR0aWNvcWh0b29idnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTc1ODcsImV4cCI6MjA3NDU3MzU4N30.QsOwyZXGOWrAv5Aj_gL0II3B970ocebhCCKeK4BgMUw"; // Public anon key; safe to expose in client apps

    // Create a Supabase browser client; used to exchange the auth code and update password.
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ----------------------------------------
    // 2) PARSE AUTH CODE FROM THE BROWSER URL
    // ----------------------------------------
    // Supabase authentication links (including password recovery) arrive here with a short-lived `code` query param.
    // Example: https://your-reset-page.xyz/?code=XYZ&redirect_to=...
    const url = new URL(window.location.href);     // Grab the full current URL in the browser
    const authCode = url.searchParams.get("code"); // Extract the `code` parameter for PKCE exchange

    // Here we find references to DOM elements we will update as the user proceeds.
    const statusEl = document.getElementById("status");      // A simple text area to show status/errors
    const formEl = document.getElementById("reset-form");    // The password entry form
    const pass1El = document.getElementById("password");     // First password field
    const pass2El = document.getElementById("password2");    // Confirm password field
    const submitEl = document.getElementById("submit-btn");  // Submit button

    // ------------------------------------
    // 3) EXCHANGE CODE → ESTABLISH SESSION
    // ------------------------------------
    // On load, if we have an auth code, exchange it for a session so the user is authenticated in this tab.
    // This is REQUIRED before calling `updateUser({ password })`.
    async function ensureSessionFromCode() {
      // If the email link didn’t include `code`, bail with a helpful message.
      if (!authCode) {
        statusEl.textContent = "Missing 'code' in URL. Open this page from your email reset link.";
        formEl.style.display = "none"; // Hide the form because we can’t proceed without a session
        return;
      }

      // Try the PKCE exchange one time on page load. If the session already exists, Supabase will no-op.
      const { error } = await supabase.auth.exchangeCodeForSession({ authCode });

      // If there’s an error, show it and disable the form.
      if (error) {
        statusEl.textContent = `Could not start reset session: ${error.message}`;
        formEl.style.display = "none";
        return;
      }

      // Success: session established. The user can now set a new password.
      statusEl.textContent = "Session verified. Enter your new password below.";
      formEl.style.display = "block"; // Reveal the form
    }

    // -------------------------------------------------
    // 4) HANDLE SUBMIT → UPDATE PASSWORD VIA SUPABASE
    // -------------------------------------------------
    formEl.addEventListener("submit", async (e) => {
      e.preventDefault(); // Prevent the browser from reloading on form submit

      // Read password values from the inputs.
      const p1 = pass1El.value; // First entry for the new password
      const p2 = pass2El.value; // Confirmation entry for the new password

      // Simple client-side validations before calling Supabase.
      if (!p1 || p1.length < 8) { // You can raise the bar per your policy (e.g., min 12 chars)
        statusEl.textContent = "Password must be at least 8 characters.";
        return;
      }
      if (p1 !== p2) { // Confirm that both entries match
        statusEl.textContent = "Passwords do not match.";
        return;
      }

      // Disable the button while we call Supabase to prevent double-submits.
      submitEl.disabled = true;
      statusEl.textContent = "Updating password…";

      // Call Supabase to update the authenticated user’s password in this session.
      const { error } = await supabase.auth.updateUser({ password: p1 });

      // Re-enable the button regardless of outcome.
      submitEl.disabled = false;

      // Show the result to the user.
      if (error) {
        statusEl.textContent = `Error: ${error.message}`;
      } else {
        statusEl.textContent = "Password updated successfully. You may now close this tab and sign in.";
        // Optionally, you can redirect them to a sign-in page on your site:
        // window.location.href = "/sign-in";
      }
    });

    // Kick off the session exchange when the page loads.
    ensureSessionFromCode(); // Run immediately on page load
  </script>

  <!-- Very light, inline styles for a clean, centered form without external CSS -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; display: grid; place-items: center; min-height: 100dvh; }
    .card { max-width: 420px; width: 100%; padding: 1.25rem; border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.12); }
    h1 { margin: 0 0 0.75rem; font-size: 1.25rem; }
    p { margin-top: 0; color: #333; }
    label { display: block; margin: 0.75rem 0 0.25rem; font-weight: 600; }
    input { width: 100%; padding: 0.65rem; border-radius: 10px; border: 1px solid #ccc; }
    button { margin-top: 1rem; width: 100%; padding: 0.8rem; border: 0; border-radius: 10px; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body> <!-- Body contains visible content and the form markup -->
  <div class="card"> <!-- A simple container with a subtle card look -->
    <h1>Reset your password</h1> <!-- Page heading -->
    <p id="status">Verifying link…</p> <!-- Area to show live status and any errors -->

    <!-- Hidden by default; becomes visible after the auth code is successfully exchanged -->
    <form id="reset-form" style="display:none;">
      <label for="password">New password</label> <!-- Label for the first password input -->
      <input id="password" type="password" autocomplete="new-password" required /> <!-- First password field -->

      <label for="password2">Confirm new password</label> <!-- Label for the confirm password input -->
      <input id="password2" type="password" autocomplete="new-password" required /> <!-- Confirmation field -->

      <button id="submit-btn" type="submit">Update password</button> <!-- Submit button to trigger updateUser -->
    </form>
  </div>
</body>
</html>
