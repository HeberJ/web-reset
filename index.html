<!--
  Updated LINK ()()()
  index.html
  PURPOSE: A minimal, browser-only password reset page for Supabase Auth.
  HOSTING: You can host this file on any static host (GitHub Pages, Netlify, Vercel, S3+CloudFront, etc.).
-->

<!DOCTYPE html> <!-- Declares HTML5 document type for the browser -->
<html lang="en"> <!-- Sets the document language to English for accessibility/search -->
<head> <!-- Head contains metadata and scripts/styles that load before the page renders -->
  <meta charset="UTF-8" /> <!-- Ensures proper character encoding for all text -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Makes layout responsive on mobile -->
  <title>Reset your password</title> <!-- Browser tab title -->

  <!-- 
    Load Supabase JS from a CDN (official ESM build).
    This gives us the `createClient` function in a module context below.
  -->
 <script type="module">
  // --- 0) Import Supabase client (ESM build) ---
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // --- 1) YOUR PROJECT CREDENTIALS (leave as you set them earlier) ---
  const SUPABASE_URL = "https://hazfkudticoqhtoobvpu.supabase.co";   // ← your project URL
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhemZrdWR0aWNvcWh0b29idnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTc1ODcsImV4cCI6MjA3NDU3MzU4N30.QsOwyZXGOWrAv5Aj_gL0II3B970ocebhCCKeK4BgMUw";                 // ← your anon public key
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);     // builds a browser client

  // --- 2) Grabbing DOM elements we’ll update ---
  const statusEl = document.getElementById("status");     // shows status/errors
  const formEl = document.getElementById("reset-form");   // new-password form
  const pass1El = document.getElementById("password");    // new password
  const pass2El = document.getElementById("password2");   // confirm password
  const submitEl = document.getElementById("submit-btn"); // submit button

  // --- 3) Parse both possible URL formats from Supabase ---
  const url = new URL(window.location.href);              // full current URL
  const authCode = url.searchParams.get("code");          // ?code=XYZ style (PKCE)
  const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, "")); // #access_token=… style
  const hashAccessToken = hashParams.get("access_token"); // token from hash
  const hashRefreshToken = hashParams.get("refresh_token");
  const hashType = hashParams.get("type");                // should be "recovery" for PW reset

  // --- 4) Try to establish a session, supporting both formats ---
  async function establishSession() {
    // 4a) New-style links: https://site/reset?code=XYZ
    if (authCode) {
      const { error } = await supabase.auth.exchangeCodeForSession({ authCode });
      if (error) {
        statusEl.textContent = `Could not start reset session: ${error.message}`;
        formEl.style.display = "none";
        return;
      }
      statusEl.textContent = "Session verified. Enter your new password below.";
      formEl.style.display = "block";
      return;
    }

    // 4b) Legacy/redirect links: https://site/reset/#access_token=…&refresh_token=…&type=recovery
    if (hashAccessToken && hashRefreshToken && hashType === "recovery") {
      const { data, error } = await supabase.auth.setSession({
        access_token: hashAccessToken,
        refresh_token: hashRefreshToken,
      });
      if (error) {
        statusEl.textContent = `Could not restore session: ${error.message}`;
        formEl.style.display = "none";
        return;
      }
      statusEl.textContent = "Session verified. Enter your new password below.";
      formEl.style.display = "block";
      return;
    }

    // 4c) Neither format was present → user didn’t arrive from a reset email
    statusEl.textContent = "Missing 'code' in URL. Open this page from your email reset link.";
    formEl.style.display = "none";
  }

  // --- 5) Submit handler: update password once session exists ---
  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();                             // don’t reload the page
    const p1 = pass1El.value;                       // read new password
    const p2 = pass2El.value;                       // read confirmation

    if (!p1 || p1.length < 8) {                     // basic policy check
      statusEl.textContent = "Password must be at least 8 characters.";
      return;
    }
    if (p1 !== p2) {                                // both entries must match
      statusEl.textContent = "Passwords do not match.";
      return;
    }

    submitEl.disabled = true;                       // prevent double submit
    statusEl.textContent = "Updating password…";    // optimistic status

    const { error } = await supabase.auth.updateUser({ password: p1 }); // call Supabase
    submitEl.disabled = false;                      // re-enable button

    if (error) {
      statusEl.textContent = `Error: ${error.message}`; // surface any errors
      return;
    }
    statusEl.textContent = "Password updated successfully. You may now close this tab and sign in.";
    // Optional: redirect after success
    // window.location.href = "https://heberj.github.io/web-reset/success.html";
  });

  // --- 6) Kick off the session establishment on page load ---
  establishSession();                               // handles both URL styles
</script>


  <!-- Very light, inline styles for a clean, centered form without external CSS -->
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 1.5rem;
      display: grid;
      place-items: center;
      min-height: 100dvh;
      background-color: #f5f5f5;
    }
    .card {
      max-width: 420px;
      width: 100%;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      background: white;
    }
    h1 {
      margin: 0 0 1rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a1a1a;
    }
    p {
      margin: 0 0 1.5rem;
      color: #666;
      line-height: 1.5;
    }
    label {
      display: block;
      margin: 1.25rem 0 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: #333;
    }
    label:first-of-type {
      margin-top: 0;
    }
    input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    button {
      margin-top: 1.5rem;
      width: 100%;
      padding: 0.875rem;
      border: 0;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      background-color: #3b82f6;
      color: white;
      transition: background-color 0.2s;
    }
    button:hover:not(:disabled) {
      background-color: #2563eb;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body> <!-- Body contains visible content and the form markup -->
  <div class="card"> <!-- A simple container with a subtle card look -->
    <h1>Reset your password</h1> <!-- Page heading -->
    <p id="status">Verifying link…</p> <!-- Area to show live status and any errors -->

    <!-- Hidden by default; becomes visible after the auth code is successfully exchanged -->
    <form id="reset-form" style="display:none;">
      <label for="password">New password</label> <!-- Label for the first password input -->
      <input id="password" type="password" autocomplete="new-password" required /> <!-- First password field -->

      <label for="password2">Confirm new password</label> <!-- Label for the confirm password input -->
      <input id="password2" type="password" autocomplete="new-password" required /> <!-- Confirmation field -->

      <button id="submit-btn" type="submit">Update password</button> <!-- Submit button to trigger updateUser -->
    </form>
  </div>
</body>
</html>
